% !TEX root = main.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{実験システムの構築}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{構造}
　本研究では，図\ref{fig:system}に示すような超小型人工衛星の模型を用いて実験を行う．
模型は，転がり軸受を利用してできるだけ滑らかに回転し，各制御理論の特性が摩擦の影響を受けることなくなるべく反映されるようになっている．
人工衛星に搭載している物は，Arduino Uno，SD Cardシールド，磁気・角度・角速度センサ，磁気トルカ駆動用の回路，磁気トルカ，9 V 角型乾電池である．
Arduinoへの電力供給は角型乾電池を用い，磁気トルカへの電力供給は菊水電子工業株式会社製のPMC18-5Aを用いる．

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.1]{./figure/実験システム.jpg}
		\caption{実験システムの外観}
		\label{fig:system}
\end{figure}

\subsection{制御システムの設計}

　搭載するArduinoは，ELEGOO社製のArduino Uno R3を，開発環境にはArduino IDEを用いる．
姿勢角度，角速度および磁力の検出には，Bosch Sensortec社のBNO055と，
Arduino IDEのライブラリ$"\mathrm{Adafruit\_Sensor.h}"$，$"\mathrm{Adafruit\_BNO055.h}"$
を用いる．また，姿勢角度，角速度および磁力の記録にはSDカードを用いており，
seeed studio社製のSD Card shield V4.0をArduinoに装着している．
センサから取得した角度，角速度および磁気のデータを用いて，フィードバック制御を行う．
記録した角度・角速度のデータをCSVファイルに保存，それをPythonでグラフに描画し，姿勢角度の遷移を確認する．

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.5]{./figure/system-crop.pdf}
		\caption{実験システム概略図}
		\label{fig:systemfig}
\end{figure}

\subsubsection{磁気トルカの制作}

　搭載した磁気トルカのパラメータを表\ref{table:torquer}に示す．
$\boldsymbol{E-B}$対応において，磁気トルカが発生させる磁気モーメントは，電流$I$，磁心の断面積$S$，法線ベクトル$\boldsymbol{n}$を用いて，
\begin{equation}
	\boldsymbol{m}=IS\boldsymbol{n}
\end{equation}
と表される．また，地磁気を$\boldsymbol{B}_\mathrm{geo}$ [T] とすると，磁気トルカがとらえる磁束密度は，
\begin{equation}
	\boldsymbol{B} = \mu_r\boldsymbol{B}_\mathrm{geo}
\end{equation}
となる．
そして，磁気トルカが発生させられるトルクは，磁気トルカの磁気モーメントと，磁気トルカがとらえる磁束密度を用いて，
\begin{equation}
	\boldsymbol{T = m \times B}
\end{equation}
と表される．

　まず，芯材にステンレス鋼を用いて磁気トルカを作り，磁石を用いて反応性を確かめた．
しかし，ステンレス鋼の保磁力の高さのため，磁気トルカに電流を流していないときも磁力を持っており，
また比透磁率も低く，電流を流しているとき，いないときの差がなく磁力も低かったため，これを用いず
PCパーマロイを用いて磁気トルカの制作を行った．
　芯材であるPCパーマロイの選定理由は，その透磁率の高さである．PCパーマロイは比透磁率が約200,000で，磁気トルカがとらえられる磁力が高くなる．
また，保磁力が低く，消磁しやすいため，必要な時だけトルクを発生させられる．


\begin{table}[H]
	\centering
	\caption{磁気トルカのパラメータ}
	\label{table:torquer}
	\begin{tabular}{|c||c|}
		\hline
		コイル長さL [mm] & 100\\ \hline
		コイル直径D [mm] & 5\\ \hline
		巻き数n [-] & 983 \\ \hline
		芯材 & PCパーマロイ \\ \hline
		線材 & ポリエステル被覆銅線 \\ \hline    
	\end{tabular}
\end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{磁気トルカの駆動回路}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{駆動回路の設計}
　図\ref{fig:cirkit1}に，最初に構築した回路図を示す．
この回路で，duty比50\%のPWM信号を入力した場合の，磁気トルカにかかる電圧を図\ref{fig:osiro1}に示す．なお，電圧のレンジは5 [V/div] である．
図\ref{fig:osiro1}のとおり，磁気トルカの逆起電力が大きい．
そのため，FETがOFFのとき，磁気トルカに流れる電流が本来流すべき方向と逆方向に流れ，逆方向のトルクが発生することが
予測された．

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/回路図1.png}
		\caption{初期の磁気トルカの駆動回路}
		\label{fig:cirkit1}
\end{figure}

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/scope_5.png}
		\caption{初期案}
		\label{fig:osiro1}
\end{figure}


　そこで次に，磁気トルカと並列にダイオードを接続することで逆起電力を防止した．
制作した回路の回路図を図\ref{fig:cirkit}に示す．
具体的には，ON時に磁気トルカに蓄えられたエネルギーを，
ダイオードを通して閉回路となった磁気トルカの抵抗
により消費することにより，逆起電力を防ぐ．

\subsubsection{磁気トルカの電流計算など}

　電流の制御をPWMで行うため，コイルの過渡特性を考慮して電流値の計算を行う必要がある．
一般的にコイルは，インダクタ成分のみでなく抵抗成分も含んでおり，低周波での等価回路は図\ref{fig:touka}のようになる．
よって，LR直列回路の過渡現象を考えればよい．
外部電源の電圧値$E$ [V]，抵抗成分$R_L [\Omega]$，インダクタンス$L$ [mH] から求められるFETがONのときの電流の過渡特性は，

\begin{equation}
	i(t) = \frac{E}{R_L}\left(1-e^{-\frac{R_L}{L}t}\right)
\end{equation}

で表される．また，FETがOFFとなったときの時刻を$t_1$ [s] とすると，その後の電流の過渡特性は，

\begin{equation}
	i(t) = \frac{E\left(1-e^{-\frac{R_L}{L}t_1}\right)}{R_L}e^{-\frac{R_L}{L}(t-t_1)}
\end{equation}

となる．さらに$t_2$ [s] 経過し，

\begin{equation}
	i(t) = \frac{E\left(1-e^{-\frac{R_L}{L}t_1}\right)e^{-\frac{R_L}{L}(t_2-t_1)}}{R_L}\left(1-e^{-\frac{R_L}{L}(t-t_1-t_2)}\right)
\end{equation}

というような電流の推移をする．

\begin{table}[H]
	\centering
	\caption{磁気トルカの等価回路}
	\label{table:torquer2}
	\begin{tabular}{|c||c|}
		\hline
		インダクタンス$L$ [mH] & 	82.0 \\ \hline
		抵抗 $R_L$ [$\Omega $] & 18.3 \\ \hline 
	\end{tabular}
\end{table}

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/touka.png}
		\caption{磁気トルカの等価回路}
		\label{fig:touka}
\end{figure}

この電流の推移を，図\ref{fig:cirkit}の回路を用いてduty比50\%でシミュレーションしたグラフを図\ref{fig:current50}に示す．
このように，磁気トルカに電圧E [V] を印加したときの電流を$I_\mathrm{max} [A]$とすると，duty比DのPWM信号で磁気トルカを駆動させたとき，
およその電流を$I(\mathrm{D})=I_\mathrm{max}D [A]$で近似できる． 
そのため電流$I$を流したいときは，$D=\frac{I}{I_\mathrm{max}}$でDuty比を決定する．

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/駆動回路.png}
		\caption{磁気トルカの駆動回路}
		\label{fig:cirkit}
\end{figure}

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/scope_11.png}
		\caption{磁気トルカに加わる電圧}
		\label{fig:osiro2}
\end{figure}

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.3]{./figure/50current.png}
		\caption{磁気トルカに流れる電流}
		\label{fig:current50}
\end{figure}

